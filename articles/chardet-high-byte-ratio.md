---
title: "ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã®ã€Œãã®å…ˆã€ã‚’ã€ãƒã‚¤ãƒˆåˆ—ãŒæ•™ãˆã¦ãã‚ŒãŸ"
emoji: "ğŸ”–"
type: "tech"
topics: ["encoding", "typescript", "nodejs"]
published: true
published_at: 2026-02-26 11:00
publication_name: "dress_code"
---

# TL;DR

![tl;dr](/images/chardet-high-byte-ratio/tldr.jpg)

# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€Dress Code ã§ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹ [ãªã„ã¨ãƒ¼](https://x.com/_bwkw_) ã§ã™ï¼

ç§ãŸã¡ã¯ [DRESS CODE](https://www.dress-code.com/ja) ã¨ã„ã†ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å‘ã‘ã® Workforce Management ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

![ãƒ‰ãƒ¡ã‚¤ãƒ³ / ãƒãƒ¼ã‚±ãƒƒãƒˆ](/images/chardet-high-byte-ratio/domain-market.png)

DRESS CODE ã§ã¯ã€æ—¥æœ¬ã€ã‚¿ã‚¤ã€ãƒ™ãƒˆãƒŠãƒ ã€ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢ã€ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ãªã©å„å›½ã®æ‹ ç‚¹ã‹ã‚‰æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ãŒ CSV ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ‹ ç‚¹ã”ã¨ã«ãƒãƒ©ãƒãƒ©ãªãŸã‚ã€ICU ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–‡å­—æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸ [node-chardet](https://github.com/runk/node-chardet) ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¤œå‡ºã—ã€[iconv-lite](https://github.com/ashtuchkin/iconv-lite) ã§ UTF-8 ã«å¤‰æ›ã™ã‚‹ä»•çµ„ã¿ã‚’å…¥ã‚Œã¾ã—ãŸã€‚

ãŸã ã€ãƒãƒ«ãƒãƒã‚¤ãƒˆç³»ã¯ã“ã‚Œã§ã†ã¾ãã„ã£ãŸã®ã§ã™ãŒã€ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆç³»ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã¯èª¤æ¤œå‡ºãŒå¤šç™ºã—ã€ä¸€ç­‹ç¸„ã§ã¯ã„ãã¾ã›ã‚“ã§ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€node-chardet ã®é™ç•Œã«ç›´é¢ã—ã€ãƒã‚¤ãƒˆåˆ—ã®çµ±è¨ˆçš„ç‰¹å¾´ã‚’è¦‹ã‚‹ã“ã¨ã§çªç ´ã—ãŸè©±ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚åŒã˜ã‚ˆã†ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã§è‹¦æˆ¦ã—ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ğŸ‘‹

# node-chardet ã®é™ç•Œã‚’çŸ¥ã‚‹

node-chardet ã¯ã€ãƒã‚¤ãƒˆåˆ—ã‹ã‚‰ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ä½¿ç”¨è¨€èªã‚’æ¨å®šã™ã‚‹åˆ¤å®šå™¨ã§ã™ã€‚

å†…éƒ¨ã¯ [ICUï¼ˆInternational Components for Unicodeï¼‰](https://icu.unicode.org/) ã®æ–‡å­—æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ãŠã‚Šã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ç¨®é¡ã«å¿œã˜ã¦ç•°ãªã‚‹åˆ¤å®šæ‰‹æ³•ã‚’ä½¿ã„åˆ†ã‘ã¦ã„ã¾ã™ã€‚

- **ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆSBCSï¼‰**
  ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨è¨€èªã®çµ„ã¿åˆã‚ã›ã”ã¨ã«ã€ã‚ˆãå‡ºç¾ã™ã‚‹ **3 ãƒã‚¤ãƒˆé€£æ¥ï¼ˆtrigramï¼‰ã®ãƒªã‚¹ãƒˆ** ã‚’æŒã£ã¦ã„ã‚‹ã€‚å…¥åŠ›ãƒã‚¤ãƒˆåˆ—ã‹ã‚‰ trigram ã‚’æŠ½å‡ºã—ã€ãƒªã‚¹ãƒˆã«ã©ã‚Œã ã‘å«ã¾ã‚Œã‚‹ã‹ï¼ˆãƒ’ãƒƒãƒˆç‡ï¼‰ã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã™ã‚‹ã€‚
- **ãƒãƒ«ãƒãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆMBCSï¼‰**
  ã¾ãšã€ãƒã‚¤ãƒˆåˆ—ãŒå„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ãƒã‚¤ãƒˆé…ç½®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã€ä¸æ­£ãªä¸¦ã³ãŒã‚ã‚Œã°å€™è£œã‹ã‚‰é™¤å¤–ã™ã‚‹ã€‚æ¬¡ã«ã€ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—ãŒ **ã‚ˆãä½¿ã‚ã‚Œã‚‹æ–‡å­—ã®ãƒªã‚¹ãƒˆï¼ˆcommonCharsï¼‰** ã«ã©ã‚Œã ã‘å«ã¾ã‚Œã‚‹ã‹ã‚’ç…§åˆã™ã‚‹ã€‚

ã„ãšã‚Œã®å ´åˆã‚‚ã€ã‚‚ã£ã¨ã‚‚ã‚¹ã‚³ã‚¢ãŒé«˜ã‹ã£ãŸã‚‚ã®ã‚’ `encoding` ã¨ã—ã¦ã€ãã®ã¨ãã®ã‚¹ã‚³ã‚¢ã‚’ `confidence` ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

https://unicode-org.github.io/icu/userguide/conversion/detection.html

ã“ã†ã—ãŸä»•çµ„ã¿ã®ãŠã‹ã’ã§ã€node-chardet ã¯ **MBCS ã®æ¤œå‡ºã«ã¯ã‹ãªã‚Šå¼·ã„** ã§ã™ã€‚

EUC-KR ã‚„ GB18030ã€Big5 ãªã©ã¯ã€é«˜ã„ confidence ã§å®‰å®šã—ã¦æ¤œå‡ºã§ãã¾ã™ã€‚ãƒãƒ«ãƒãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ã€Œç‰¹å®šã®ç¯„å›²ã®ãƒã‚¤ãƒˆã—ã‹å‡ºãªã„ã€ã€Œãƒã‚¤ãƒˆåˆ—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã¯ã£ãã‚Šã—ã¦ã„ã‚‹ã€ã¨ã„ã£ãŸæ§‹é€ çš„ãªç‰¹å¾´ãŒå¼·ãã€ä¸æ­£ãªãƒã‚¤ãƒˆåˆ—ãŒã‚ã‚Œã°å³åº§ã«å€™è£œã‹ã‚‰é™¤å¤–ã§ãã‚‹ã†ãˆã€commonChars ç…§åˆã§ã‚‚è¨€èªé–“ã®å·®ãŒã¯ã£ãã‚Šå‡ºã‚„ã™ã„ãŸã‚ã§ã™ã€‚

ä¸€æ–¹ã§ã€**SBCS ã®æ¤œå‡ºã¯ãã†ã¯ã„ãã¾ã›ã‚“**ã€‚

ã¾ãšã€node-chardet ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹ SBCS ã¯ ISO-8859 ç³»ã‚„ Windows-125x ç³»ãŒä¸­å¿ƒã§ã€**TIS-620ï¼ˆã‚¿ã‚¤èªï¼‰ã‚„ Windows-1258ï¼ˆãƒ™ãƒˆãƒŠãƒ èªï¼‰ã¯ãã‚‚ãã‚‚æ¤œå‡ºå¯¾è±¡ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“**ã€‚ãã®ãŸã‚ã€ã‚¿ã‚¤èªã‚„ãƒ™ãƒˆãƒŠãƒ èªã® CSV ã‚’å…¥åŠ›ã—ã¦ã‚‚ã€node-chardet ã¯å€™è£œã¨ã—ã¦è¿”ã™ã“ã¨ãŒã§ããšã€ä»£ã‚ã‚Šã« trigram ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¿‘ã„åˆ¥ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿”ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ãã‚‚ãã‚‚ SBCS ã¯ 0x00ã€œ0xFF ã® 256 å€‹ã®ãƒã‚¤ãƒˆã‚’ 1 æ–‡å­—ãšã¤å‰²ã‚Šå½“ã¦ã‚‹æ–¹å¼ã§ã€ISO-8859-1ï¼ˆè¥¿ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘è¨€èªï¼‰ã€ISO-8859-7ï¼ˆã‚®ãƒªã‚·ãƒ£èªï¼‰ã€TIS-620ï¼ˆã‚¿ã‚¤èªï¼‰ã€Windows-1258ï¼ˆãƒ™ãƒˆãƒŠãƒ èªï¼‰ãªã©ã¯ã€åŒã˜ 256 ã‚¹ãƒ­ãƒƒãƒˆã‚’ã€Œã©ã®æ–‡å­—ã‚’ç½®ãã‹ã€ã ã‘å¤‰ãˆã¦å…±æœ‰ã—ã¦ã„ã¾ã™ã€‚ã©ã® SBCS ã‚‚ ASCII é ˜åŸŸï¼ˆ0x00ã€œ0x7Fï¼‰ã®ä½¿ã„æ–¹ãŒã»ã¼åŒã˜ãŸã‚ã€CSV ã®ã‚ˆã†ã«ã‚«ãƒ³ãƒã‚„æ•°å­—ãŒå¤šã„ãƒ‡ãƒ¼ã‚¿ã§ã¯ trigram ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¨€èªé–“ã§ä¼¼é€šã„ã‚„ã™ããªã‚Šã¾ã™ã€‚

å®Ÿéš›ã«ç§ãŸã¡ã®ç’°å¢ƒã§ã¯ã€**ã‚¿ã‚¤èªï¼ˆTIS-620ï¼‰â†’ ã‚®ãƒªã‚·ãƒ£èªï¼ˆISO-8859-7ï¼‰ã€ãƒ™ãƒˆãƒŠãƒ èªï¼ˆWindows-1258ï¼‰â†’ è¥¿ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘è¨€èªï¼ˆISO-8859-1ï¼‰ã¨ã„ã†èª¤æ¤œå‡ºãŒå¤šç™º** ã—ã¾ã—ãŸã€‚ã“ã‚Œã¯ node-chardet ã®ãƒã‚°ã§ã¯ãªãã€TIS-620 / Windows-1258 ãŒæ¤œå‡ºå¯¾è±¡å¤–ã§ã‚ã‚‹ã“ã¨ã€ãã—ã¦ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿ã® SBCS åŒå£«ã§ã‚‚åŒã˜ 1 ãƒã‚¤ãƒˆç©ºé–“ã‚’å…±æœ‰ã—ã¦ãŠã‚Š trigram ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å·®ãŒå°ã•ã„ã¨ã„ã†ã€æ–¹å¼ãã®ã‚‚ã®ã®é™ç•Œã§ã™ã€‚

ãã®ãŸã‚ã€ã€Œnode-chardet ã‚’å…¥ã‚ŒãŸã‹ã‚‰çµ‚ã‚ã‚Šã€ã§ã¯ãªãã€ã€Œç‰¹ã« 1 ãƒã‚¤ãƒˆç³»ã¯èª¤æ¤œå‡ºã‚’å‰æã«ã€ä½•ã‹ã—ã‚‰ã‚¬ãƒ¼ãƒ‰ã‚’è¶³ã™å¿…è¦ãŒã‚ã‚‹ã€ã¨ã„ã†ã®ãŒã€ã“ã®æ™‚ç‚¹ã§ã®çµè«–ã§ã—ãŸã€‚

ã¨ã¯ã„ãˆã€ç¾åœ¨ã®ã‚¿ã‚¤ã‚„ãƒ™ãƒˆãƒŠãƒ ã§ã¯ UTF-8 ãŒä¸»æµãªã®ã§ã€å®Ÿéš›ã« TIS-620 ã‚„ Windows-1258 ã® CSV ãŒæ¥ã‚‹ã‚±ãƒ¼ã‚¹ã¯ã»ã¼ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã€ãƒ¬ã‚¬ã‚·ãƒ¼ãªã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãªã©ã€ã„ã¤æ¥ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„é UTF-8 ã® CSV ã«ã¯å‚™ãˆã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# ãƒã‚¤ãƒˆåˆ—ã§å€™è£œã‚’çµã‚‹

ãã“ã§ã€node-chardet ãŒè¦‹ã¦ã„ã‚‹ã€Œtrigram ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã®ä¸€è‡´åº¦ã€ã¨ã¯åˆ¥ã«ã€**ç”Ÿã®ãƒã‚¤ãƒˆåˆ—ãã®ã‚‚ã®**ã«æ‰‹ãŒã‹ã‚ŠãŒãªã„ã‹ã‚’æ¢ã—ã¾ã—ãŸã€‚ã“ã“ã‹ã‚‰ã¯ã€å®Œç’§ã§ã¯ãªã„ãŒå®Ÿç”¨çš„ã«ååˆ†ãªåˆ¤å®šæ‰‹æ³•ã€ã„ã‚ã‚†ã‚‹ [Heuristic](https://en.wikipedia.org/wiki/Heuristic) ã‚’è‡ªå‰ã§çµ„ã¿ç«‹ã¦ã¦ã„ãã¾ã™ã€‚

> A heuristic is any approach to problem solving that employs a pragmatic method that is not fully optimized, perfected, or rationalized, but is nevertheless "good enough" as an approximation.

ç€ç›®ã—ãŸã®ã¯ **high byte ratio ï¼ ãƒã‚¤ãƒˆåˆ—å…¨ä½“ã®ã†ã¡ 0x80 ä»¥ä¸Šï¼ˆhigh byteï¼‰ãŒå ã‚ã‚‹å‰²åˆ**ã§ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã¯ã€è¨€èªå›ºæœ‰ã®æ–‡å­—ãŒã“ã®é ˜åŸŸã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¨€èªã«ã‚ˆã£ã¦ high byte ã®å‡ºç¾é »åº¦ãŒå¤§ããç•°ãªã‚Šã¾ã™ã€‚

ã‚¿ã‚¤èªï¼ˆTIS-620ï¼‰ã§ã¯ã€ã‚¿ã‚¤æ–‡å­—ãŒ 0xA1ã€œ0xFB ã«é›†ä¸­ã—ã¦ã„ã¾ã™ã€‚ã‚¿ã‚¤æ–‡å­—ã¯ã™ã¹ã¦ 0x80 ä»¥ä¸Šã®ãƒã‚¤ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã¯ä¸¸ã”ã¨ high byteï¼ˆ0x80 ä»¥ä¸Šï¼‰ã§ã™ã€‚CSV ä¸­ã§ low byteï¼ˆ0x7F ä»¥ä¸‹ï¼‰ã«ãªã‚‹ã®ã¯ã‚«ãƒ³ãƒãƒ»æ”¹è¡Œãƒ»æ•°å­—ã¨ã„ã£ãŸ ASCII æ–‡å­—ã ã‘ã§ã™ã€‚

ãŸã¨ãˆã°ã€ã‚¿ã‚¤èª CSV ã® 1 è¡Œã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
CSV:    à¸ªà¸¡à¸Šà¸²à¸¢,à¹ƒà¸ˆà¸”à¸µ,25,à¸à¸£à¸¸à¸‡à¹€à¸—à¸
ãƒã‚¤ãƒˆ: CA C1 AA D2 C2 2C E3 A8 B4 D5 2C 32 35 2C A1 C3 D8 A7 E0 B7 BE
        ^^^^^^^^^^^^^^^^^ 2C ^^^^^^^^^ 2C ^^^^ 2C ^^^^^^^^^^^^^^^^^^^^^
          ã‚¿ã‚¤æ–‡å­—(â‰¥0x80)   ,  ã‚¿ã‚¤æ–‡å­—   , æ•°å­—  ,      ã‚¿ã‚¤æ–‡å­—
```

ã‚«ãƒ³ãƒï¼ˆ`0x2C`ï¼‰ã¨æ•°å­—ï¼ˆ`0x32`, `0x35`ï¼‰ä»¥å¤–ã¯ã»ã¼ã™ã¹ã¦ 0x80 ä»¥ä¸Šã§ã™ã€‚

```
ãƒã‚¤ãƒˆå€¤:  0x00 .................. 0x7F 0x80 .................. 0xFF
           [  ASCII (æ•°å­—,ã‚«ãƒ³ãƒ)  ]    [ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ]
                 å°‘ãªã„                      ã‚¿ã‚¤æ–‡å­—ãŒãã£ã—ã‚Š
```

ä¸€æ–¹ã€ãƒ™ãƒˆãƒŠãƒ èªï¼ˆWindows-1258ï¼‰ã¯ãƒ©ãƒ†ãƒ³æ–‡å­—ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚æ–‡å­—åˆ—ã®å¤§éƒ¨åˆ†ã¯ ASCII ç¯„å›²ã®ãƒ©ãƒ†ãƒ³æ–‡å­—ã§ã€å£°èª¿è¨˜å·ä»˜ãã®æ–‡å­—ï¼ˆÆ¡, Æ°, Äƒ, Ä‘ ãªã©ï¼‰ã ã‘ãŒ 0x80 ä»¥ä¸Šã‚’ä½¿ã„ã¾ã™ã€‚

```
CSV:    Nguyá»…n,HÆ°Æ¡ng,25,HÃ  Ná»™i
ãƒã‚¤ãƒˆ: 4E 67 75 79 EA DE 6E 2C 48 FD F5 6E 67 2C 32 35 2C 48 E0 20 4E F4 F2 69
        ^^^^^^^^^^^^^^^^^^^^^ 2C ^^^^^^^^^^^^^^ 2C ^^^^ 2C ^^^^^^^^^^^^^^^^^^^^^^
         Ãª,combining tilde ã ã‘ â‰¥0x80  Æ°,Æ¡ ã ã‘ â‰¥0x80  æ•°å­—     Ã ,Ã´,dot below ã ã‘ â‰¥0x80
```

`Nguyá»…n` ã® 7 ãƒã‚¤ãƒˆä¸­ã€0x80 ä»¥ä¸Šã¯ `EA`ï¼ˆÃªï¼‰ã¨ `DE`ï¼ˆcombining tildeï¼‰ã® 2 ãƒã‚¤ãƒˆã ã‘ã€‚æ®‹ã‚Šã¯ã™ã¹ã¦ ASCII ã§ã™ã€‚

```
ãƒã‚¤ãƒˆå€¤:  0x00 .................. 0x7F 0x80 .................. 0xFF
           [ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ]    [  â–‘â–‘  ]
               ãƒ©ãƒ†ãƒ³æ–‡å­—ãŒå¤§éƒ¨åˆ†            å£°èª¿è¨˜å·ã ã‘
```

ã“ã®å·®ã¯å®Ÿéš›ã«ã©ã®ç¨‹åº¦ã‹ã€‚å„è¨€èªã§ãƒªã‚¢ãƒ«ãª CSV ã‚’ 1,000 è¡Œç”Ÿæˆã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ©ãƒ ã¨æ•°å€¤ã‚«ãƒ©ãƒ ã®æ¯”ç‡ã‚’å¤‰ãˆã¦è¨ˆæ¸¬ã—ã¾ã—ãŸã€‚

| CSV ã®åˆ—æ§‹æˆ         | ã‚¿ã‚¤èª(TIS-620) | ãƒ™ãƒˆãƒŠãƒ èª(Windows-1258) | å·®   |
| -------------------- | --------------- | ------------------------ | ---- |
| ãƒ†ã‚­ã‚¹ãƒˆ 3 : æ•°å€¤ 1  | â‰’ 77%           | â‰’ 23%                    | 54pt |
| ãƒ†ã‚­ã‚¹ãƒˆ 5 : æ•°å€¤ 1  | â‰’ 83%           | â‰’ 24%                    | 59pt |
| ãƒ†ã‚­ã‚¹ãƒˆ 10 : æ•°å€¤ 0 | â‰’ 90%           | â‰’ 27%                    | 63pt |

:::message
ã“ã‚Œã¯æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹è¨ˆæ¸¬å€¤ãªã®ã§ã€å®Ÿéš›ã® CSV ã®å†…å®¹ï¼ˆå£°èª¿è¨˜å·ã®å¯†åº¦ã‚„åˆ—æ§‹æˆï¼‰ã«ã‚ˆã£ã¦æ•°ãƒã‚¤ãƒ³ãƒˆç¨‹åº¦ã®ã‚ºãƒ¬ã¯ã‚ã‚Šå¾—ã¾ã™ã€‚ã¾ãŸã€æ•°å€¤ã‚«ãƒ©ãƒ ãŒå¤§åŠã‚’å ã‚ã‚‹æ¥µç«¯ãª CSV ã§ã¯ä¸¡æ–¹ã¨ã‚‚æ¯”ç‡ãŒä¸‹ãŒã‚Šã€ã“ã® Heuristic ã ã‘ã§ã¯åŒºåˆ¥ã§ããªããªã‚Šã¾ã™ã€‚ãã®å ´åˆã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ãŒå®‰å…¨è£…ç½®ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
:::

ãƒ™ãƒˆãƒŠãƒ èªã¯å­éŸ³ãŒã»ã¼ ASCII ã§ã€high byte ã«ãªã‚‹ã®ã¯ Ä‘ ã¨ä¸€éƒ¨ã®æ¯éŸ³ï¼ˆÆ¡, Æ°, Äƒ ç­‰ï¼‰ã€å£°èª¿è¨˜å·ã® combining mark ã ã‘ã§ã™ã€‚ãã®ãŸã‚ã€å£°èª¿è¨˜å·ãŒå¤šã„ CSV ã§ã‚‚ Windows-1258 ã® high byte ratio ã¯ 30% æœªæº€ã«åã¾ã‚Šã¾ã™ã€‚ä¸€æ–¹ã€TIS-620 ã¯å…¸å‹çš„ãªæ§‹æˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆ 3 : æ•°å€¤ 1ï¼‰ã§ã‚‚ç´„ 77% ã‚ã‚Šã€ä¸¡è€…ã®é–“ã«ã¯å¸¸ã« 50 ãƒã‚¤ãƒ³ãƒˆä»¥ä¸Šã®å·®ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®å·®ã‚’åˆ©ç”¨ã—ã¦ã€é–¾å€¤ã‚’ä¸­é–“ã«ã‚ãŸã‚‹ **50%** ã«è¨­å®šã—ã¾ã—ãŸã€‚high byte ratio ãŒ 50% ã‚’è¶…ãˆã¦ã„ãŸã‚‰ã€Œã‚¿ã‚¤èªï¼ˆTIS-620ï¼‰å€™è£œã€ã€50% ä»¥ä¸‹ãªã‚‰ã€Œãƒ™ãƒˆãƒŠãƒ èªï¼ˆWindows-1258ï¼‰å€™è£œã€ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã«ã™ã‚‹ã¨ã€ãƒã‚¤ãƒˆåˆ—ã‚’ 1 å›èµ°æŸ»ã—ã¦ 0x80 ä»¥ä¸Šã®å‰²åˆã‚’è¿”ã™ã ã‘ã§ã™ã€‚

ãªãŠã€ãƒã‚¤ãƒˆåˆ—ã‹ã‚‰ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¨æ¸¬ã™ã‚‹å‡¦ç†ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã«ãªã‚ŠãŒã¡ã§ã™ãŒã€ä»Šå›ã®å®Ÿè£…ã§ã¯ node-chardet ã«ã‚ˆã‚‹æ¤œå‡ºã‚‚ Heuristic ã‚‚ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ã‚‚ã€ã™ã¹ã¦ **å…ˆé ­ 64KB ã®ã‚µãƒ³ãƒ—ãƒ«**ã«å¯¾ã—ã¦ã®ã¿è¡Œã„ã¾ã™ã€‚CSV ã¯è¡Œã®ç¹°ã‚Šè¿”ã—æ§‹é€ ãªã®ã§ã€å…ˆé ­ 64KBï¼ˆæ•°ç™¾ã€œåƒè¡Œç¨‹åº¦ï¼‰ã§çµ±è¨ˆçš„ç‰¹å¾´ã¯ååˆ†ã«ç¾ã‚Œã¾ã™ã€‚æ®‹ã‚Šã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§å‡¦ç†ã™ã‚‹ãŸã‚ã€æ•° GB ã® CSV ã§ã‚‚ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã—ã¾ã›ã‚“ã€‚

```typescript
const HIGH_BYTE_RATIO_THRESHOLD = 0.5;

function getRetryCandidate(buffer: Buffer): string {
  return highByteRatio(buffer) > HIGH_BYTE_RATIO_THRESHOLD
    ? "tis-620"
    : "windows-1258";
}

function highByteRatio(buffer: Buffer): number {
  let count = 0;
  for (const byte of buffer) {
    if (byte >= 0x80) count++;
  }
  return count / buffer.length;
}
```

ãŸã ã—ã€ã“ã‚Œã¯ã‚ãã¾ã§å€™è£œã‚’çµã‚‹æ®µéšã§ã™ã€‚ã€Œã‚¿ã‚¤èªã£ã½ã„ã€ã¨åˆ¤å®šã—ã¦ã‚‚ã€æœ¬å½“ã«ã‚¿ã‚¤èªã‹ã©ã†ã‹ã¯ã¾ã åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚

# ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ã§ç¢ºå®šã™ã‚‹

high byte ratio ã§çµã£ãŸå€™è£œãŒæœ¬å½“ã«æ­£ã—ã„ã‹ã‚’ã€å®Ÿéš›ã«ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦æ¤œè¨¼ã—ã¾ã™ã€‚å€™è£œã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã€ä»¥ä¸‹ã® 2 ã¤ã®æ¡ä»¶ã‚’ä¸¡æ–¹æº€ãŸã—ãŸå ´åˆã ã‘æ¡ç”¨ã—ã¾ã™ã€‚

1. **è¨€èªå›ºæœ‰æ–‡å­—ãŒ 1 æ–‡å­—ä»¥ä¸Šå«ã¾ã‚Œã¦ã„ã‚‹** â€” ã‚¿ã‚¤èªãªã‚‰ Unicode ã® Thai ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆU+0E00ã€œU+0E7Fï¼‰ã€ãƒ™ãƒˆãƒŠãƒ èªãªã‚‰ Æ¡, Æ°, Äƒ, Ä‘, Ã¢, Ãª, Ã´ ã¨ã„ã£ãŸãƒ©ãƒ†ãƒ³æ‹¡å¼µæ–‡å­—
2. **U+FFFDï¼ˆæ–‡å­—åŒ–ã‘ï¼‰ãŒå¢—ãˆã¦ã„ãªã„** â€” å€™è£œã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã® U+FFFD ã®æ•°ãŒã€å…ƒã® node-chardet çµæœä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨

```typescript
function selectBestEncoding(sample: Buffer, initialEncoding: string): string {
  const initialResult = decode(sample, initialEncoding);
  const initialBadChars = countReplacementChars(initialResult);

  const candidate = getRetryCandidate(sample);
  const scorer =
    candidate === "tis-620" ? scoreThaiChars : scoreVietnameseChars;

  const candidateResult = decode(sample, candidate);
  const candidateBadChars = countReplacementChars(candidateResult);
  const candidateScore = scorer(candidateResult);

  if (candidateScore > 0 && candidateBadChars <= initialBadChars) {
    return candidate;
  }

  return initialEncoding;
}
```

`candidateScore > 0`ï¼ˆå›ºæœ‰æ–‡å­—ã‚ã‚Šï¼‰ã‹ã¤ `candidateBadChars <= initialBadChars`ï¼ˆæ–‡å­—åŒ–ã‘ãŒå¢—ãˆã¦ã„ãªã„ï¼‰ã‚’æº€ãŸã•ãªã‘ã‚Œã°ã€å€™è£œã¯æ£„å´ã—ã¦ `initialEncoding` ã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚Heuristic ãŒå¤–ã‚Œã¦ã‚‚æ—¢å­˜ã®å‹•ä½œã‚’å£Šã•ãªã„ã€å®‰å…¨ã«è©¦è¡Œã§ãã‚‹è¨­è¨ˆã§ã™ã€‚

ã“ã“ã¾ã§ã® node-chardet ã«ã‚ˆã‚‹åˆæœŸæ¤œå‡ºã€Heuristic ã«ã‚ˆã‚‹è£œæ­£ã€ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒç¢ºå®šã—ãŸã‚‰ã€iconv-lite ã§ UTF-8 ã«å¤‰æ›ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€ãã®å¤‰æ›å¾Œã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã‚‚ã€æœ€çµ‚é˜²è¡›ãƒ©ã‚¤ãƒ³ã¨ã—ã¦å…¨ä½“ã‚’ç›£è¦–ã—ã¦ã„ã¾ã™ã€‚

```typescript
class ReplacementCharDetector extends Transform {
  override _transform(
    chunk: string,
    _encoding: BufferEncoding,
    callback: Function
  ) {
    if (chunk.includes("\uFFFD")) {
      callback(new Error("garbled characters detected"));
      return;
    }
    callback(null, chunk);
  }
}
```

U+FFFD ã‚’ 1 æ–‡å­—ã§ã‚‚æ¤œå‡ºã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã—ã¾ã™ã€‚æ­£å¸¸ãªæ¥­å‹™ CSV ã« `ï¿½` ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã¯å®Ÿè³ªãªã„ã®ã§ã€1 æ–‡å­—ã§ã‚‚ã‚ã‚Œã°åˆ¤å®šãƒŸã‚¹ã¨ã¿ãªã—ã€æ–‡å­—åŒ–ã‘ãƒ‡ãƒ¼ã‚¿ã‚’å¾Œç¶šã«æµã™ã‚ˆã‚Šã‚‚ãã®å ´ã§æ­¢ã‚ã‚‹ã»ã†ãŒå®‰å…¨ã¨ã„ã†åˆ¤æ–­ã§ã™ã€‚

# ãŠã‚ã‚Šã«

node-chardet ã¯ãƒãƒ«ãƒãƒã‚¤ãƒˆç³»ã®æ¤œå‡ºã«ã¯å¼·ã„ä¸€æ–¹ã§ã€TIS-620 ã‚„ Windows-1258 ã¯æ¤œå‡ºå¯¾è±¡å¤–ã§ã‚ã‚Šã€ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿ã® SBCS åŒå£«ã§ã‚‚æ§‹é€ çš„ã«åŒºåˆ¥ãŒé›£ã—ã„ã¨ã„ã†é™ç•ŒãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒã‚°ã§ã¯ãªãã€æ¤œå‡ºå¯¾è±¡ã®ç¯„å›²ã¨ã€ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ã„ã†ä»•çµ„ã¿ã®æœ¬è³ªçš„ãªåˆ¶ç´„ã§ã™ã€‚

ã—ã‹ã—ã€ä»Šå›ç´¹ä»‹ã—ãŸã‚ˆã†ã«ãƒã‚¤ãƒˆåˆ—ã‚’è¦³å¯Ÿã™ã‚‹ã¨ã€è¨€èªã«ã‚ˆã£ã¦ high byteï¼ˆ0x80 ä»¥ä¸Šï¼‰ã®å‰²åˆãŒå¤§ããé•ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã®å·®ã‚’åˆ©ç”¨ã—ãŸé–¾å€¤åˆ¤å®šã¨ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¤èªãƒ»ãƒ™ãƒˆãƒŠãƒ èªã‚’å«ã‚€å¤šè¨€èªã® CSV ãŒæ–‡å­—åŒ–ã‘ãªãé€šã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ãŸã ã—ã€ã“ã®æ‰‹æ³•ã¯ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ãŒå˜ä¸€ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã‚ã‚‹ã“ã¨ãŒå‰æã§ã™ã€‚1ã¤ã® CSV å†…ã«è¤‡æ•°ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒæ··åœ¨ã—ã¦ã„ã‚‹å ´åˆï¼ˆä¾‹ï¼šä¸€éƒ¨ã®åˆ—ã ã‘ CP932 ã§æ®‹ã‚ŠãŒ UTF-8ï¼‰ã¯ã€è‡ªå‹•æ¤œå‡ºã§ã¯åŸç†çš„ã«å¯¾å‡¦ã§ãã¾ã›ã‚“ã€‚ãã‚Œã§ã‚‚ã€ã€Œå˜ä¸€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã® SBCS ã‚’æ­£ã—ãæ¤œå‡ºã™ã‚‹ã€ã¨ã„ã†ç¯„å›²ã§ã¯ã€ååˆ†ã«å®Ÿç”¨çš„ãªã‚¬ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®è¨˜äº‹ãŒã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã§åŒã˜ã‚ˆã†ãªå£ã«ã¶ã¤ã‹ã£ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ğŸ‘‹
