---
title: "ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã®ã€Œãã®å…ˆã€ã‚’ã€ãƒã‚¤ãƒˆåˆ—ãŒæ•™ãˆã¦ãã‚ŒãŸ"
emoji: "ğŸ”"
type: "tech"
topics: ["encoding", "chardet", "typescript", "nodejs"]
published: false
publication_name: "dress_code"
---

# TL;DR

![tl;dr](/images/chardet-high-byte-ratio/tldr.jpg)

# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€Dress Code ã§ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹ [ãªã„ã¨ãƒ¼](https://x.com/_bwkw_) ã§ã™ï¼

ç§ãŸã¡ã¯ [DRESS CODE](https://www.dress-code.com/ja) ã¨ã„ã†ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å‘ã‘ã® Workforce Management ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

![ãƒ‰ãƒ¡ã‚¤ãƒ³ / ãƒãƒ¼ã‚±ãƒƒãƒˆ](/images/chardet-high-byte-ratio/domain-market.png)

DRESS CODE ã§ã¯ã€æ—¥æœ¬ã€ã‚¿ã‚¤ã€ãƒ™ãƒˆãƒŠãƒ ã€ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢ã€ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ãªã©å„å›½ã®æ‹ ç‚¹ã‹ã‚‰æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ãŒ CSV ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ‹ ç‚¹ã”ã¨ã«ãƒãƒ©ãƒãƒ©ã§ã™ãŒã€å†…éƒ¨ã§ã¯ UTF-8 ã«çµ±ä¸€ã—ã¦æ‰±ã„ãŸã„ã€‚ãã“ã§ã€Mozilla ã®è‡ªå‹•æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸ [chardet](https://github.com/runk/node-chardet) ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¤œå‡ºã—ã€[iconv-lite](https://github.com/ashtuchkin/iconv-lite) ã§ UTF-8 ã«å¤‰æ›ã™ã‚‹ä»•çµ„ã¿ã‚’å…¥ã‚Œã¾ã—ãŸã€‚

ãŸã ã€ãƒãƒ«ãƒãƒã‚¤ãƒˆç³»ã¯ã“ã‚Œã§ã†ã¾ãã„ã£ãŸã®ã§ã™ãŒã€ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆç³»ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã¯èª¤æ¤œå‡ºãŒå¤šç™ºã—ã€ä¸€ç­‹ç¸„ã§ã¯ã„ãã¾ã›ã‚“ã§ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€chardet ã®é™ç•Œã«ç›´é¢ã—ã€ãƒã‚¤ãƒˆåˆ—ã®çµ±è¨ˆçš„ç‰¹å¾´ã‚’è¦‹ã‚‹ã“ã¨ã§çªç ´ã—ãŸè©±ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚åŒã˜ã‚ˆã†ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã§è‹¦æˆ¦ã—ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ğŸ‘‹

# chardet ã®é™ç•Œ

chardet ã¯ã€ãƒã‚¤ãƒˆåˆ—ã‹ã‚‰ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ä½¿ç”¨è¨€èªã‚’æ¨å®šã™ã‚‹åˆ¤å®šå™¨ã§ã™ã€‚

å†…éƒ¨ã§ã¯ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ç¨®é¡ã«å¿œã˜ã¦ç•°ãªã‚‹åˆ¤å®šæ‰‹æ³•ã‚’ä½¿ã„åˆ†ã‘ã¦ã„ã¾ã™ã€‚

- **ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆSBCSï¼‰**ï¼šã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨è¨€èªã®çµ„ã¿åˆã‚ã›ã”ã¨ã« bigramï¼ˆ2 ãƒã‚¤ãƒˆé€£æ¥ï¼‰ã®é »åº¦åˆ†å¸ƒã‚’**è¨€èªãƒ¢ãƒ‡ãƒ«**ã¨ã—ã¦æŒã¡ã€å…¥åŠ›ãƒã‚¤ãƒˆåˆ—ã® bigram é »åº¦ã‚’ã“ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ç…§åˆã—ã¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
- **ãƒãƒ«ãƒãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**ï¼šãƒã‚¤ãƒˆåˆ—ã®ä¸¦ã³é †ãŒ valid ã‹ invalid ã‹ã‚’åˆ¤å®šã™ã‚‹**çŠ¶æ…‹é·ç§»ãƒã‚·ãƒ³ï¼ˆcoding state machineï¼‰**ã¨ã€ãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã®æ–‡å­—ã®å‡ºç¾é »åº¦ã‚’è©•ä¾¡ã™ã‚‹**æ–‡å­—åˆ†å¸ƒåˆ†æï¼ˆcharacter distribution analysisï¼‰**ã® 2 æ®µæ§‹ãˆ

ã„ãšã‚Œã®å ´åˆã‚‚ã€ã‚‚ã£ã¨ã‚‚ã‚¹ã‚³ã‚¢ãŒé«˜ã‹ã£ãŸã‚‚ã®ã‚’ `encoding` ã¨ã—ã¦ã€ãã®ã¨ãã®ã‚¹ã‚³ã‚¢ã‚’ `confidence` ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

https://chardet.readthedocs.io/en/latest/how-it-works.html

ã“ã†ã—ãŸä»•çµ„ã¿ã®ãŠã‹ã’ã§ã€**MBCS ã«ã¯ã‹ãªã‚Šå¼·ã„**ã§ã™ã€‚

EUC-KR ã‚„ GB18030ã€Big5 ãªã©ã¯ã€é«˜ã„ confidence ã§å®‰å®šã—ã¦æ¤œå‡ºã§ãã¾ã™ï¼ˆå°‘ãªãã¨ã‚‚ã€è‡ªå‰ã§ç”¨æ„ã—ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã§ã¯ã»ã¼å¤–ã—ã¾ã›ã‚“ã§ã—ãŸï¼‰ã€‚ãƒãƒ«ãƒãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ã€Œç‰¹å®šã®ç¯„å›²ã®ãƒã‚¤ãƒˆã—ã‹å‡ºãªã„ã€ã€Œãƒã‚¤ãƒˆåˆ—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã¯ã£ãã‚Šã—ã¦ã„ã‚‹ã€ã¨ã„ã£ãŸæ§‹é€ çš„ãªç‰¹å¾´ãŒå¼·ãã€çŠ¶æ…‹é·ç§»ãƒã‚·ãƒ³ãŒä¸æ­£ãªãƒã‚¤ãƒˆåˆ—ã‚’æ¤œå‡ºã—ãŸæ™‚ç‚¹ã§å³åº§ã«å€™è£œã‹ã‚‰é™¤å¤–ã§ãã‚‹ã†ãˆã€æ–‡å­—åˆ†å¸ƒåˆ†æã§ã‚‚è¨€èªé–“ã®å·®ãŒã¯ã£ãã‚Šå‡ºã‚„ã™ã„ã®ã ã¨æ€ã„ã¾ã™ã€‚

ä¸€æ–¹ã§ã€**SBCS ã¯ãã†ã¯ã„ãã¾ã›ã‚“**ã€‚

SBCS ã¯ 0x00ã€œ0xFF ã® 256 å€‹ã®ãƒã‚¤ãƒˆã‚’ 1 æ–‡å­—ãšã¤å‰²ã‚Šå½“ã¦ã‚‹æ–¹å¼ã§ã€ISO-8859-1ï¼ˆè¥¿ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘è¨€èªï¼‰ã€ISO-8859-7ï¼ˆã‚®ãƒªã‚·ãƒ£èªï¼‰ã€TIS-620ï¼ˆã‚¿ã‚¤èªï¼‰ã€Windows-1258ï¼ˆãƒ™ãƒˆãƒŠãƒ èªï¼‰ãªã©ã¯ã€åŒã˜ 256 ã‚¹ãƒ­ãƒƒãƒˆã‚’ã€Œã©ã®æ–‡å­—ã‚’ç½®ãã‹ã€ã ã‘å¤‰ãˆã¦å…±æœ‰ã—ã¦ã„ã¾ã™ã€‚chardet ã¯ SBCS ã«ã¤ã„ã¦å…¥åŠ›ãƒã‚¤ãƒˆåˆ—ã® bigram é »åº¦ã‚’å„è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ç…§åˆã—ã¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã¾ã™ãŒã€ã©ã® SBCS ã‚‚ ASCII é ˜åŸŸï¼ˆ0x00ã€œ0x7Fï¼‰ã®ä½¿ã„æ–¹ãŒã»ã¼åŒã˜ãŸã‚ã€CSV ã®ã‚ˆã†ã«ã‚«ãƒ³ãƒã‚„æ•°å­—ãŒå¤šã„ãƒ‡ãƒ¼ã‚¿ã§ã¯ bigram ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¨€èªé–“ã§ä¼¼é€šã„ã‚„ã™ããªã‚Šã¾ã™ã€‚

ãã®çµæœã€ã€Œã‚®ãƒªã‚·ãƒ£èªã®è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã‚‚ãã“ãã“åˆã†ã—ã€ã‚¿ã‚¤èªã®è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã‚‚ãã“ãã“åˆã†ã€ã¨ã„ã£ãŸåƒ…å·®ã®å‹è² ã«ãªã‚Šã‚„ã™ãã€ç§ãŸã¡ã®ç’°å¢ƒã§ã‚‚ã€ã‚¿ã‚¤èªï¼ˆTIS-620ï¼‰ãŒã‚®ãƒªã‚·ãƒ£èªï¼ˆISO-8859-7ï¼‰ã«ã€ãƒ™ãƒˆãƒŠãƒ èªï¼ˆWindows-1258ï¼‰ãŒè¥¿ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘è¨€èªï¼ˆISO-8859-1ï¼‰ã«èª¤æ¤œå‡ºã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒå¤šãè¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚

ã“ã‚Œã¯ chardet ã®ãƒã‚°ã¨ã„ã†ã‚ˆã‚Šã€ã€Œã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åŒå£«ãŒåŒã˜ 1 ãƒã‚¤ãƒˆç©ºé–“ã‚’å…±æœ‰ã—ã¦ãŠã‚Šã€bigram ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å·®ãŒå°ã•ã„ã€ã¨ã„ã†æ–¹å¼ãã®ã‚‚ã®ã®é™ç•Œã«è¿‘ã„æŒ™å‹•ã§ã™ã€‚ãã®ãŸã‚ã€ã€Œchardet ã‚’å…¥ã‚ŒãŸã‹ã‚‰çµ‚ã‚ã‚Šã€ã§ã¯ãªãã€ã€Œç‰¹ã« 1 ãƒã‚¤ãƒˆç³»ã¯èª¤æ¤œå‡ºã‚’å‰æã«ã€ä½•ã‹ã—ã‚‰ã‚¬ãƒ¼ãƒ‰ã‚’è¶³ã™å¿…è¦ãŒã‚ã‚‹ã€ã¨ã„ã†ã®ãŒã€ã“ã®æ™‚ç‚¹ã§ã®çµè«–ã§ã—ãŸã€‚

# ãƒã‚¤ãƒˆåˆ—ã§å€™è£œã‚’çµã‚‹

ãã“ã§ã€chardet ãŒè¦‹ã¦ã„ã‚‹ã€Œè¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã®ä¸€è‡´åº¦ã€ã¨ã¯åˆ¥ã«ã€**ç”Ÿã®ãƒã‚¤ãƒˆåˆ—ãã®ã‚‚ã®**ã«æ‰‹ãŒã‹ã‚ŠãŒãªã„ã‹ã‚’æ¢ã—ã¾ã—ãŸã€‚ã“ã“ã‹ã‚‰ã¯ã€å®Œç’§ã§ã¯ãªã„ãŒå®Ÿç”¨çš„ã«ååˆ†ãªåˆ¤å®šæ‰‹æ³•ã€ã„ã‚ã‚†ã‚‹ [Heuristic](https://en.wikipedia.org/wiki/Heuristic) ã‚’è‡ªå‰ã§çµ„ã¿ç«‹ã¦ã¦ã„ãã¾ã™ã€‚

> A heuristic is any approach to problem solving that employs a pragmatic method that is not fully optimized, perfected, or rationalized, but is nevertheless "good enough" as an approximation.

ç€ç›®ã—ãŸã®ã¯ **high byte ratio ï¼ ãƒã‚¤ãƒˆåˆ—å…¨ä½“ã®ã†ã¡ 0x80 ä»¥ä¸Šï¼ˆhigh byteï¼‰ãŒå ã‚ã‚‹å‰²åˆ**ã§ã™ã€‚ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã¯ã€è¨€èªå›ºæœ‰ã®æ–‡å­—ãŒã“ã®é ˜åŸŸã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¨€èªã«ã‚ˆã£ã¦ high byte ã®å‡ºç¾é »åº¦ãŒå¤§ããç•°ãªã‚Šã¾ã™ã€‚

ã‚¿ã‚¤èªï¼ˆTIS-620ï¼‰ã§ã¯ã€ã‚¿ã‚¤æ–‡å­—ãŒ 0xA1ã€œ0xFB ã«é›†ä¸­ã—ã¦ã„ã¾ã™ã€‚ã‚¿ã‚¤æ–‡å­—ã¯ã™ã¹ã¦ 0x80 ä»¥ä¸Šã®ãƒã‚¤ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã¯ä¸¸ã”ã¨ high byteï¼ˆ0x80 ä»¥ä¸Šï¼‰ã§ã™ã€‚CSV ä¸­ã§ low byteï¼ˆ0x7F ä»¥ä¸‹ï¼‰ã«ãªã‚‹ã®ã¯ã‚«ãƒ³ãƒãƒ»æ”¹è¡Œãƒ»æ•°å­—ã¨ã„ã£ãŸ ASCII æ–‡å­—ã ã‘ã§ã™ã€‚

ãŸã¨ãˆã°ã€ã‚¿ã‚¤èª CSV ã® 1 è¡Œã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
CSV:    à¸ªà¸¡à¸Šà¸²à¸¢,à¹ƒà¸ˆà¸”à¸µ,25,à¸à¸£à¸¸à¸‡à¹€à¸—à¸
ãƒã‚¤ãƒˆ: CA C1 AA D2 C2 2C E3 A8 B4 D5 2C 32 35 2C A1 C3 D8 A7 E0 B7 BE
        ^^^^^^^^^^^^^^^^^ 2C ^^^^^^^^^ 2C ^^^^ 2C ^^^^^^^^^^^^^^^^^^^^^
          ã‚¿ã‚¤æ–‡å­—(â‰¥0x80)   ,  ã‚¿ã‚¤æ–‡å­—   , æ•°å­—  ,      ã‚¿ã‚¤æ–‡å­—
```

ã‚«ãƒ³ãƒï¼ˆ`0x2C`ï¼‰ã¨æ•°å­—ï¼ˆ`0x32`, `0x35`ï¼‰ä»¥å¤–ã¯ã»ã¼ã™ã¹ã¦ 0x80 ä»¥ä¸Šã§ã™ã€‚

```
ãƒã‚¤ãƒˆå€¤:  0x00 .................. 0x7F 0x80 .................. 0xFF
           [  ASCII (æ•°å­—,ã‚«ãƒ³ãƒ)  ]    [ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ]
                 å°‘ãªã„                      ã‚¿ã‚¤æ–‡å­—ãŒãã£ã—ã‚Š
```

ä¸€æ–¹ã€ãƒ™ãƒˆãƒŠãƒ èªï¼ˆWindows-1258ï¼‰ã¯ãƒ©ãƒ†ãƒ³æ–‡å­—ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚æ–‡å­—åˆ—ã®å¤§éƒ¨åˆ†ã¯ ASCII ç¯„å›²ã®ãƒ©ãƒ†ãƒ³æ–‡å­—ã§ã€å£°èª¿è¨˜å·ä»˜ãã®æ–‡å­—ï¼ˆÆ¡, Æ°, Äƒ, Ä‘ ãªã©ï¼‰ã ã‘ãŒ 0x80 ä»¥ä¸Šã‚’ä½¿ã„ã¾ã™ã€‚

```
CSV:    Nguyá»…n,HÆ°Æ¡ng,25,HÃ  Ná»™i
ãƒã‚¤ãƒˆ: 4E 67 75 79 EA DE 6E 2C 48 FD F5 6E 67 2C 32 35 2C 48 E0 20 4E F4 F2 69
        ^^^^^^^^^^^^^^^^^^^^^ 2C ^^^^^^^^^^^^^^ 2C ^^^^ 2C ^^^^^^^^^^^^^^^^^^^^^^
          ã»ã¼ ASCII             Æ°,Æ¡ ã ã‘ â‰¥0x80   æ•°å­—       Ã ,Ã´,dot below ã ã‘ â‰¥0x80
```

`Nguyá»…n` ã® 7 ãƒã‚¤ãƒˆä¸­ã€0x80 ä»¥ä¸Šã¯ `EA`ï¼ˆÃªï¼‰ã¨ `DE`ï¼ˆcombining tildeï¼‰ã® 2 ãƒã‚¤ãƒˆã ã‘ã€‚æ®‹ã‚Šã¯ã™ã¹ã¦ ASCII ã§ã™ã€‚

```
ãƒã‚¤ãƒˆå€¤:  0x00 .................. 0x7F 0x80 .................. 0xFF
           [ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ]    [  â–‘â–‘  ]
               ãƒ©ãƒ†ãƒ³æ–‡å­—ãŒå¤§éƒ¨åˆ†            å£°èª¿è¨˜å·ã ã‘
```

ã“ã®å·®ã¯å®Ÿéš›ã«ã©ã®ç¨‹åº¦ã‹ã€‚å„è¨€èªã§ãƒªã‚¢ãƒ«ãª CSV ã‚’ 10,000 è¡Œç”Ÿæˆã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ©ãƒ ã¨æ•°å€¤ã‚«ãƒ©ãƒ ã®æ¯”ç‡ã‚’å¤‰ãˆã¦è¨ˆæ¸¬ã—ã¾ã—ãŸã€‚

| CSV ã®åˆ—æ§‹æˆ         | ã‚¿ã‚¤èª(TIS-620) | ãƒ™ãƒˆãƒŠãƒ èª(Windows-1258) | å·®   |
| -------------------- | --------------- | ------------------------ | ---- |
| ãƒ†ã‚­ã‚¹ãƒˆ 3 : æ•°å€¤ 1  | â‰’ 77%           | â‰’ 23%                    | 54pt |
| ãƒ†ã‚­ã‚¹ãƒˆ 5 : æ•°å€¤ 1  | â‰’ 83%           | â‰’ 24%                    | 59pt |
| ãƒ†ã‚­ã‚¹ãƒˆ 10 : æ•°å€¤ 0 | â‰’ 90%           | â‰’ 27%                    | 63pt |

:::message
ã“ã‚Œã¯æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹è¨ˆæ¸¬å€¤ãªã®ã§ã€å®Ÿéš›ã® CSV ã®å†…å®¹ï¼ˆå£°èª¿è¨˜å·ã®å¯†åº¦ã‚„åˆ—æ§‹æˆï¼‰ã«ã‚ˆã£ã¦æ•°ãƒã‚¤ãƒ³ãƒˆç¨‹åº¦ã®ã‚ºãƒ¬ã¯ã‚ã‚Šå¾—ã¾ã™ã€‚ã¾ãŸã€æ•°å€¤ã‚«ãƒ©ãƒ ãŒå¤§åŠã‚’å ã‚ã‚‹æ¥µç«¯ãª CSV ã§ã¯ä¸¡æ–¹ã¨ã‚‚æ¯”ç‡ãŒä¸‹ãŒã‚Šã€ã“ã® Heuristic ã ã‘ã§ã¯åŒºåˆ¥ã§ããªããªã‚Šã¾ã™ã€‚ãã®å ´åˆã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ãŒå®‰å…¨è£…ç½®ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
:::

ãƒ™ãƒˆãƒŠãƒ èªã¯å­éŸ³ãŒã™ã¹ã¦ ASCII ã§ã€high byte ã«ãªã‚‹ã®ã¯ä¸€éƒ¨ã®æ¯éŸ³ï¼ˆÆ¡, Æ°, Äƒ ç­‰ï¼‰ã¨å£°èª¿è¨˜å·ã® combining mark ã ã‘ã§ã™ã€‚ãã®ãŸã‚ã€å£°èª¿è¨˜å·ãŒå¤šã„ CSV ã§ã‚‚ Windows-1258 ã® high byte ratio ã¯ 30% æœªæº€ã«åã¾ã‚Šã¾ã™ã€‚ä¸€æ–¹ã€TIS-620 ã¯å…¸å‹çš„ãªæ§‹æˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆ 3 : æ•°å€¤ 1ï¼‰ã§ã‚‚ç´„ 77% ã‚ã‚Šã€ä¸¡è€…ã®é–“ã«ã¯å¸¸ã« 50 ãƒã‚¤ãƒ³ãƒˆä»¥ä¸Šã®å·®ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®å·®ã‚’åˆ©ç”¨ã—ã¦ã€é–¾å€¤ã‚’ä¸­é–“ã«ã‚ãŸã‚‹ **50%** ã«è¨­å®šã—ã¾ã—ãŸã€‚high byte ratio ãŒ 50% ã‚’è¶…ãˆã¦ã„ãŸã‚‰ã€Œã‚¿ã‚¤èªï¼ˆTIS-620ï¼‰å€™è£œã€ã€50% ä»¥ä¸‹ãªã‚‰ã€Œãƒ™ãƒˆãƒŠãƒ èªï¼ˆWindows-1258ï¼‰å€™è£œã€ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã«ã™ã‚‹ã¨ã€ãƒã‚¤ãƒˆåˆ—ã‚’ 1 å›èµ°æŸ»ã—ã¦ 0x80 ä»¥ä¸Šã®å‰²åˆã‚’è¿”ã™ã ã‘ã§ã™ã€‚

```typescript
const HIGH_BYTE_RATIO_THRESHOLD = 0.5;

function getRetryCandidate(buffer: Buffer): string {
  return highByteRatio(buffer) > HIGH_BYTE_RATIO_THRESHOLD
    ? "tis-620"
    : "windows-1258";
}

function highByteRatio(buffer: Buffer): number {
  let count = 0;
  for (const byte of buffer) {
    if (byte >= 0x80) count++;
  }
  return count / buffer.length;
}
```

ãŸã ã—ã€ã“ã‚Œã¯ã‚ãã¾ã§å€™è£œã‚’çµã‚‹æ®µéšã§ã™ã€‚ã€Œã‚¿ã‚¤èªã£ã½ã„ã€ã¨åˆ¤å®šã—ã¦ã‚‚ã€æœ¬å½“ã«ã‚¿ã‚¤èªã‹ã©ã†ã‹ã¯ã¾ã åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚

# ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ã§ç¢ºå®šã™ã‚‹

high byte ratio ã§çµã£ãŸå€™è£œãŒæœ¬å½“ã«æ­£ã—ã„ã‹ã‚’ã€å®Ÿéš›ã«ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦æ¤œè¨¼ã—ã¾ã™ã€‚å€™è£œã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã€ä»¥ä¸‹ã® 2 ã¤ã®æ¡ä»¶ã‚’ä¸¡æ–¹æº€ãŸã—ãŸå ´åˆã ã‘æ¡ç”¨ã—ã¾ã™ã€‚

1. **è¨€èªå›ºæœ‰æ–‡å­—ãŒ 1 æ–‡å­—ä»¥ä¸Šå«ã¾ã‚Œã¦ã„ã‚‹** â€” ã‚¿ã‚¤èªãªã‚‰ Unicode ã® Thai ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆU+0E00ã€œU+0E7Fï¼‰ã€ãƒ™ãƒˆãƒŠãƒ èªãªã‚‰ Æ¡, Æ°, Äƒ, Ä‘ ã¨ã„ã£ãŸå›ºæœ‰ã®ãƒ©ãƒ†ãƒ³æ‹¡å¼µæ–‡å­—
2. **U+FFFDï¼ˆæ–‡å­—åŒ–ã‘ï¼‰ãŒå¢—ãˆã¦ã„ãªã„** â€” å€™è£œã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã® U+FFFD ã®æ•°ãŒã€å…ƒã® chardet çµæœä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨

```typescript
function selectBestEncoding(sample: Buffer, initialEncoding: string): string {
  const initialResult = decode(sample, initialEncoding);
  const initialBadChars = countReplacementChars(initialResult);

  const candidate = getRetryCandidate(sample);
  const scorer =
    candidate === "tis-620" ? scoreThaiChars : scoreVietnameseChars;

  const candidateResult = decode(sample, candidate);
  const candidateBadChars = countReplacementChars(candidateResult);
  const candidateScore = scorer(candidateResult);

  if (candidateScore > 0 && candidateBadChars <= initialBadChars) {
    return candidate;
  }

  return initialEncoding;
}
```

`candidateScore > 0`ï¼ˆå›ºæœ‰æ–‡å­—ã‚ã‚Šï¼‰ã‹ã¤ `candidateBadChars <= initialBadChars`ï¼ˆæ–‡å­—åŒ–ã‘ãŒå¢—ãˆã¦ã„ãªã„ï¼‰ã‚’æº€ãŸã•ãªã‘ã‚Œã°ã€å€™è£œã¯æ£„å´ã—ã¦ `initialEncoding` ã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚Heuristic ãŒå¤–ã‚Œã¦ã‚‚æ—¢å­˜ã®å‹•ä½œã‚’å£Šã•ãªã„ã€å®‰å…¨ã«è©¦è¡Œã§ãã‚‹è¨­è¨ˆã§ã™ã€‚

ã•ã‚‰ã«ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç¢ºå®šå¾Œã® UTF-8 å¤‰æ›ã§ã‚‚ã€æœ€çµ‚é˜²è¡›ãƒ©ã‚¤ãƒ³ã¨ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ å…¨ä½“ã‚’ç›£è¦–ã—ã¦ã„ã¾ã™ã€‚

```typescript
class ReplacementCharDetector extends Transform {
  override _transform(
    chunk: string,
    _encoding: BufferEncoding,
    callback: Function
  ) {
    if (chunk.includes("\uFFFD")) {
      callback(new Error("garbled characters detected"));
      return;
    }
    callback(null, chunk);
  }
}
```

U+FFFD ã‚’ 1 æ–‡å­—ã§ã‚‚æ¤œå‡ºã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã—ã¾ã™ã€‚æ­£å¸¸ãªæ¥­å‹™ CSV ã« `ï¿½` ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã¯å®Ÿè³ªãªã„ã®ã§ã€1 æ–‡å­—ã§ã‚‚ã‚ã‚Œã°åˆ¤å®šãƒŸã‚¹ç¢ºå®šã€‚æ–‡å­—åŒ–ã‘ãƒ‡ãƒ¼ã‚¿ã‚’å¾Œç¶šã«æµã™ã‚ˆã‚Šã‚‚ã€ãã®å ´ã§æ­¢ã‚ã‚‹ã»ã†ãŒå®‰å…¨ã§ã™ã€‚

# ãŠã‚ã‚Šã«

chardet ã¯ãƒãƒ«ãƒãƒã‚¤ãƒˆç³»ï¼ˆCJKï¼‰ã«ã¯å¼·ã„ä¸€æ–¹ã§ã€ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆç³»ï¼ˆã‚¿ã‚¤èªãƒ»ãƒ™ãƒˆãƒŠãƒ èªãƒ»å„ç¨® ISO-8859ï¼‰ã¯æ§‹é€ çš„ã«åŒºåˆ¥ãŒé›£ã—ã„ã€‚ã“ã‚Œã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒã‚°ã§ã¯ãªãã€ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ã„ã†ä»•çµ„ã¿ã®æœ¬è³ªçš„ãªé™ç•Œã§ã™ã€‚

ã—ã‹ã—ã€ä»Šå›ç´¹ä»‹ã—ãŸã‚ˆã†ã«ãƒã‚¤ãƒˆåˆ—ã‚’è¦³å¯Ÿã™ã‚‹ã¨ã€è¨€èªã«ã‚ˆã£ã¦ high byteï¼ˆ0x80 ä»¥ä¸Šï¼‰ã®å‰²åˆãŒå¤§ããé•ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã®å·®ã‚’åˆ©ç”¨ã—ãŸé–¾å€¤åˆ¤å®šã¨ãƒ‡ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¤èªãƒ»ãƒ™ãƒˆãƒŠãƒ èªã‚’å«ã‚€å¤šè¨€èªã® CSV ãŒæ–‡å­—åŒ–ã‘ãªãé€šã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã§åŒã˜ã‚ˆã†ãªå£ã«ã¶ã¤ã‹ã£ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ğŸ‘‹
